---
title: "Trying out ffanalytics"
author: "Tom Kain"
date: "8/16/2019"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ffanalytics)
library(here)
```

```{r scrape}
scraped_data <-
  scrape_data(src = c("CBS", "Yahoo", "FantasyPros", "FantasySharks", "NumberFire", "NFL"),
              pos = c("QB", "RB", "WR", "TE", "DST", "K"),
              season = 2019, week = 0)

scraped_data %>%
  saveRDS(here("data", "ffanalytics_scrape.RDS"))

scraped_data <- 
  here("data", "ffanalytics_scrape.RDS") %>% 
  readRDS()
```

```{r scoring_table}
scoring_table <-
  list(
  pass = list(
    pass_att = 0, pass_comp = 0, pass_inc = 0, pass_yds = 0.06667, pass_tds = 4,
    pass_int = -2, pass_40_yds = 0,  pass_300_yds = 0, pass_350_yds = 0,
    pass_400_yds = 0
  ),
  rush = list(
    all_pos = TRUE,
    rush_yds = 0.1,  rush_att = 0, rush_40_yds = 0, rush_tds = 6,
    rush_100_yds = 0, rush_150_yds = 0, rush_200_yds = 0),
  rec = list(
    all_pos = TRUE,
    rec = .5, rec_yds = 0.1, rec_tds = 6, rec_40_yds = 0, rec_100_yds = 0,
    rec_150_yds = 0, rec_200_yds = 0
  ),
  misc = list(
    all_pos = TRUE,
    fumbles_lost = -2, fumbles_total = 0,
    sacks = 0, two_pts = 2
  ),
  kick = list(
    xp = 1.0, fg_0019 = 1.5,  fg_2029 = 1.5, fg_3039 = 1.5, fg_4049 = 2.5,
    fg_50 = 3.5,  fg_miss = 0.0
  ),
  ret = list(
    all_pos = TRUE,
    return_tds = 6, return_yds = 0
  ),
  idp = list(
    all_pos = TRUE,
    idp_solo = 0, idp_asst = 0, idp_sack = 0, idp_int = 0,  idp_fum_force = 0,
    idp_fum_rec = 0,  idp_pd = 0, idp_td = 0,  idp_safety = 0
  ),
  dst = list(
    dst_fum_rec = 2,  dst_int = 2, dst_safety = 2, dst_sacks = 1, dst_td = 6,
    dst_blk = 2, dst_ret_yds = 0, dst_pts_allowed = 0
  ),
  pts_bracket = list(
    list(threshold = 0, points = 9),
    list(threshold = 6, points = 8),
    list(threshold = 13, points = 7),
    list(threshold = 20, points = 5),
    list(threshold = 27, points = 4),
    list(threshold = 34, points = 3)
  )
)

# TODO include defensive yards allowed (read in via projected_points calc_projections.R:210)
```

```{r source_weights}
weights <- c(CBS = 1, Yahoo = 1,  ESPN = 1,  NFL = 1,
                    FFToday = .5, NumberFire = 1, FantasyPros = 1,
                    FantasySharks= .5, FantasyFootballNerd = .5,
                    Walterfootball = .5, RTSports= 0.5,
                    FantasyData= 0.5, FleaFlicker = 0.5)
# TODO add fantasyfootballers, the Athletic
```

```{r calculate_projections}
projections <-
  projections_table(data_result = scraped_data, 
                    scoring_rules = scoring_table)
  
projections %>% 
  add_ecr() %>% 
  add_risk() %>% 
  add_adp() 
  add_aav() %>%
  add_player_info()

# projections %>%
#   saveRDS(here("data", "rawProjections.Rds"))

projections <- readRDS(here("data", "rawProjections.Rds"))

projections %>% add_aav()
```

### Projection Columns

1. id - unique ID for each player across all sources
2. first name
3. last name
4. team - NFL team
5. position / pos
6. age - player age
7. exp - ?
8. avg_type - robust ( [Wilcoxon signed-rank test](https://en.wikipedia.org/wiki/Wilcoxon_signed-rank_test) ), average (mean), weighted (weighted mean by default or inputted source weighting)
9. points
10. pos_rank - position rank by avg_type
11. drop_off - difference in points between player and mean points of the next two players down rank
12. sd_pts - standard deviation in points aross all sources
13. floor - least projected points within confidence interval
14. ceiling - most projected points within confidence interval
15. tier - positional ranking tier
16. points_vor - ?
17. rank - overall rank by total points
18. floor_vor - ?
19. floor_rank - ?
20. ceiling_vor - ?
21. ceiling_rank - ?
22. pos_ecr - ?
23. sd_ecr - ?
24. ecr - ?
25. risk - ?
26. adp
27. adp_diff - ?

Reviewed the projections_table method through line 400 (next up, tier thresholds and assignment, then VOR, then the add_* functions)


```{r scrape_week}

week <- 10

week_scrape <- 
  scrape_data(src = c("NumberFire", 
                      "FantasyPros", 
                      "Yahoo", 
                      "FantasySharks", 
                      "FFToday"),
              pos = c("QB", "RB", "WR", "TE", "DST", "K"),
              season = 2019, week = week)

week_projections <- 
  week_scrape %>% 
  projections_table(data_result = .,
                    scoring_rules = scoring_table) %>% 
  add_ecr() %>% 
  add_risk() %>% 
  add_player_info()


week_projections %>% 
  arrange(avg_type, position, pos_rank) %>% 
  write_csv(here("data", paste0("week",week,"_projections.csv")))

week_scrape %>% saveRDS(here("data", paste0("week",week,"_scrape.Rds")))

week_scrape <- readRDS(here("data", paste0("week",week,"_scrape.Rds")))


week1$QB %>% 
  filter(id %in% c(13589,10700)) %>% 
  mutate(rush_yds = if_else(is.na(rush_yds),0,rush_yds),
         rush_tds = if_else(is.na(rush_tds),0,rush_tds)) %>% 
  mutate(points = 
           (pass_yds / 15) +
           (pass_tds * 4) +
           (pass_int * -2) +
           (rush_yds / 10) +
           (rush_tds * 6)) %>% 
  arrange(data_src, id) %>% 
  select(data_src, player, points, pass_comp:rush_tds) %>%
  View()

```